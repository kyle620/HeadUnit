###############################################################################
# PROJECT     : Embedded Wizard Application Demo
###############################################################################
export MAKEFLAGS += --silent

###############################################################################
# GENERAL PROJECT CONFIGURATION
###############################################################################
APP_FILE           = EmbeddedWizard-RasPi-4B

###############################################################################
# GENERAL SETTINGS & PATHS
###############################################################################
EMWI_APP_PATH     = ../GeneratedCode

SRC_PATH          = ../Source
EMWI_RTE_PATH     = ../../PlatformPackage/RTE
EMWI_GFX_PATH     = ../../PlatformPackage/RGBA8888
EMWI_BSP_PATH     = ../../TargetSpecific
#WIRINGPI_PATH     = /home/pi/wiringPi/wiringPi
WIRINGPI_PATH     = /usr/include
OBJ_PATH          = ./obj
BIN_PATH          = .

SDK_PATH          = /usr/include
LIB_PATH          = $(SDK_PATH)/lib

###############################################################################
# Include wiringPi library if package installed
###############################################################################
ifneq (,$(wildcard $(WIRINGPI_PATH)/wiringPi.h))
  WIRINGPI_LIB = wiringPi
endif

###############################################################################
# Include standard rules and utilities
# Include Embedded Wizard configuration and list of generated source code
###############################################################################
include utilities.mk
include rules.mk

ifeq (,$(wildcard $(EMWI_APP_PATH)/ewfiles.inc))
  $(error ERROR: $n$nThe file '(EMWI_APP_PATH)/ewfiles.inc' is missing!\
    $nPlease open Embedded Wizard project and generate code before calling make!)
endif

include $(EMWI_APP_PATH)/ewfiles.inc
include $(EMWI_GFX_PATH)/ewgfx.inc
include $(EMWI_RTE_PATH)/ewrte.inc

###############################################################################
# Standard directories for C files
###############################################################################
vpath %.c           $(SRC_PATH)                                                \
                    $(EMWI_APP_PATH)                                           \
                    $(EMWI_RTE_PATH)                                           \
                    $(EMWI_GFX_PATH)                                           \
                    $(EMWI_BSP_PATH)                                           \

##############################################################################
# EMBEDDED WIZARD - APPLICATION DEMO
###############################################################################
APP_C =                                                                        \
                    main.c                                                     \
                    ewmain.c                                                   \
                    gfx_system_drm.c                                           \
                    DeviceDriver.c                                             \

# automatically compile all files generated by Embedded Wizard
APP_EMWI_C =        $(EMWIFILES)

# compile all files for the Embedded Wizard Runtime Environment (RTE)
RTE_EMWI_C =        $(EMWI_RTE_FILES)

# compile all files for the Embedded Wizard Graphics Engine (GFX)
GFX_EMWI_C =        $(EMWI_GFX_FILES)

BSP_EMWI_C =                                                                   \
                    ew_bsp_display.c                                           \
                    ew_bsp_touch.c                                             \
                    ew_bsp_console.c                                           \


###############################################################################
# LIBRARIES
###############################################################################
LIBS :=     m                                                                 \
            GLESv2                                                            \
            EGL                                                               \
            pthread                                                           \
            drm                                                               \
            gbm                                                               \
            $(EMWI_RTE_LIB)                                                   \
            $(EMWI_GFX_LIB)                                                   \
            $(WIRINGPI_LIB)                                                   \


###############################################################################
# INCLUDES
###############################################################################
INCLUDES =                                                                     \
            -I$(SRC_PATH)                                                      \
            -I$(EMWI_APP_PATH)                                                 \
            -I$(EMWI_RTE_PATH)                                                 \
            -I$(EMWI_GFX_PATH)                                                 \
            -I$(EMWI_BSP_PATH)                                                 \
            -I$(WIRINGPI_PATH)                                                 \
            -I$(SDK_PATH)/libdrm                                               \


###############################################################################
# DEFINES
###############################################################################
CFLAGS  = -O2 -Wall -pipe                                                      \


###############################################################################
# OBJECTS
###############################################################################
APP_OBJ           := $(foreach file,$(APP_C),             $(OBJ_PATH)/$(strip $(basename $(file))).o)
APP_EMWI_OBJ      := $(foreach file,$(APP_EMWI_C),        $(OBJ_PATH)/$(strip $(basename $(file))).o)
RTE_EMWI_OBJ      := $(foreach file,$(RTE_EMWI_C),        $(OBJ_PATH)/$(strip $(basename $(file))).o)
GFX_EMWI_OBJ      := $(foreach file,$(GFX_EMWI_C),        $(OBJ_PATH)/$(strip $(basename $(file))).o)
BSP_EMWI_OBJ      := $(foreach file,$(BSP_EMWI_C),        $(OBJ_PATH)/$(strip $(basename $(file))).o)

OBJS := $(APP_OBJ) $(APP_EMWI_OBJ) $(RTE_EMWI_OBJ) $(GFX_EMWI_OBJ) $(BSP_EMWI_OBJ)

LINKING   = $(CC) $(addprefix -L,$(LIB_PATH)) $(OBJS)                          \
            $(addprefix -L,$(EMWI_RTE_PATH))                                   \
            $(addprefix -L,$(EMWI_GFX_PATH))                                   \
            $(addprefix -l,$(LIBS))                                            \
            -o $(BIN_PATH)/$(APP_FILE)


###############################################################################
# RULES
###############################################################################
$(APP_FILE): precompile $(OBJS)
	@echo Linking $(APP_FILE)
	@echo $(LINKING)
	$(LINKING)
	@echo $(APP_FILE) successfully built !!

projectecho:
	@echo -------------------------------------------------
	@echo Creating $(APP_FILE)
	@echo -------------------------------------------------
	@echo Compiler Options: $(CCRUN_STD)

createdirs:
	@echo -------------------------------------------------
	@echo Creating object and library directories
	-$(MKDIR) $(OBJ_PATH)
	@echo -------------------------------------------------


precompile: projectecho createdirs ;

.PHONY: clean
clean:
	@echo "Clean" $(OBJ_PATH)
	-$(RM) $(OBJ_PATH)/*.o

include $(wildcard $(patsubst %,%.d,$(basename $(OBJS))))
